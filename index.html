<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Anomaly Trading System</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Source+Code+Pro:wght@400;700;900&family=Comfortaa:wght@700&family=Roboto+Slab:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#FBAD60",
            "glow-orange": "#FBAD60",
            "background-light": "#efeee9",
            "background-dark": "#292929",
            "text-main-light": "#4a4a4a",
            "text-sub-light": "#8d8d8d",
            "text-main-dark": "#e0e0e0",
            "text-sub-dark": "#a0a0a0",
          },
          fontFamily: {
            display: ["Nunito", "sans-serif"],
          },
          boxShadow: {
            'neu-flat-light': '6px 6px 16px #d1cfc4, -6px -6px 16px #ffffff',
            'neu-pressed-light': 'inset 6px 6px 10px #d1cfc4, inset -6px -6px 10px #ffffff',
            'neu-icon-light': '5px 5px 10px #d1cfc4, -5px -5px 10px #ffffff',
            'neu-flat-dark': '6px 6px 16px #1b1b1b, -6px -6px 16px #373737',
            'neu-pressed-dark': 'inset 6px 6px 10px #1b1b1b, inset -6px -6px 10px #373737',
            'neu-icon-dark': '5px 5px 10px #1b1b1b, -5px -5px 10px #373737',
            'glow-orange': '0 0 8px rgba(251, 173, 96, 0.6), 0 0 16px rgba(251, 173, 96, 0.4), 0 0 24px rgba(251, 173, 96, 0.2)',
          }
        },
      },
    };
  </script>
  <style>
    :root {
      --accent-color: #FFB76A;
      --accent-r: 255;
      --accent-g: 183;
      --accent-b: 106;
      --accent-glow: rgba(255, 183, 106, 0.8);
      --accent-glow-soft: rgba(255, 183, 106, 0.4);
    }
    body { font-family: 'Nunito', sans-serif; }

    /* Prevent text cursor and selection on non-input elements */
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    /* Allow selection only in text areas and inputs */
    input, textarea {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #d1cfc4; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb { background: #373737; }

    .loading-overlay {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .loading-overlay.hidden { opacity: 0; visibility: hidden; }

    .spinner {
      width: 40px; height: 40px;
      border: 3px solid var(--accent-color);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @keyframes livePulse {
      0% {
        background: rgb(0, 180, 0);
        box-shadow: 0 0 3px rgba(0, 180, 0, 0.6), 0 0 6px rgba(0, 180, 0, 0.3);
      }
      50% {
        background: rgb(0, 255, 0);
        box-shadow: 0 0 8px rgba(0, 255, 0, 1), 0 0 14px rgba(0, 255, 0, 0.8), 0 0 20px rgba(0, 255, 0, 0.5);
      }
      100% {
        background: rgb(0, 180, 0);
        box-shadow: 0 0 3px rgba(0, 180, 0, 0.6), 0 0 6px rgba(0, 180, 0, 0.3);
      }
    }
    .live-pulse {
      animation: livePulse 2s ease-in-out infinite;
      position: relative;
      top: -1px;
    }

    @keyframes chartPointPulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.7;
        transform: scale(1.3);
      }
    }

    .text-primary-glow {
      color: var(--accent-color);
      text-shadow: 0 0 8px var(--accent-glow);
    }
    .dark .text-primary-glow {
      color: var(--accent-color);
    }

    .progress-container {
      display: flex;
      gap: 1.5rem;
    }
    @media (max-width: 640px) {
      .progress-container {
        flex-direction: column;
        gap: 1rem;
      }
    }
    .progress-track {
      height: 6px;
      border-radius: 10px;
      box-shadow: inset 2px 2px 5px #d1cfc4, inset -2px -2px 5px #ffffff;
      background: #e0e0e0;
    }
    .dark .progress-track {
      background: #1f1f1f;
      box-shadow: inset 2px 2px 5px #1b1b1b, inset -2px -2px 5px #373737;
    }
    .progress-fill {
      height: 100%;
      border-radius: 10px;
      transition: width 1s ease-out;
      background: var(--accent-color);
      box-shadow: 0 0 6px var(--accent-glow);
    }
    .dark .progress-fill {
      background: var(--accent-color);
    }

    /* Page sections */
    .page-section {
      display: none;
    }
    .page-section.active {
      display: block;
    }

    /* Active navigation state */
    .nav-item.active {
      box-shadow: inset 6px 6px 10px #d1cfc4, inset -6px -6px 10px #ffffff;
    }
    .dark .nav-item.active {
      box-shadow: inset 6px 6px 10px #1b1b1b, inset -6px -6px 10px #373737;
    }
    .nav-item.active .material-icons-round {
      color: var(--accent-color);
      text-shadow: 0 0 8px var(--accent-glow);
    }
    .dark .nav-item.active .material-icons-round {
      color: var(--accent-color);
    }

    /* Text Scramble Effect */
    .title-monospace {
      font-family: 'Source Code Pro', monospace;
      font-weight: 700;
    }

    /* Header Protocol Name Hover */
    header .title-monospace {
      transition: opacity 0.2s ease;
    }
    header .title-monospace:hover {
      opacity: 0.7;
    }

    /* Header Anomaly Scramble Effect */
    #header-anomaly-word {
      display: inline-block;
      min-width: 7ch;
    }
    #header-anomaly-word span {
      display: inline-block;
      transition: color 10s ease-out, text-shadow 10s ease-out;
    }
    #scramble-word {
      display: inline-block;
      min-width: 7.5ch;
      text-align: center;
    }
    #scramble-word span {
      display: inline-block;
    }

    /* Logic Page Styles */
    .logic-tf-card {
      cursor: pointer;
      transition: box-shadow 0.2s ease;
    }
    .logic-tf-card .tf-label {
      transition: color 0.3s ease, text-shadow 0.3s ease;
    }
    .logic-tf-card .material-icons-round,
    .logic-tf-card p {
      transition: color 0.3s ease, text-shadow 0.3s ease;
    }
    .logic-tf-btn {
      transition: all 0.2s ease;
    }

    /* Dot Indicators */
    .indicator-dots {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .indicator-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #d1cfc4;
      transition: all 0.3s ease;
    }
    .indicator-dot.small {
      width: 8px;
      height: 8px;
    }
    .dark .indicator-dot {
      background: #373737;
    }
    .indicator-dot.active {
      background: var(--accent-color);
      box-shadow: 0 0 8px var(--accent-glow);
    }

    /* Segment Indicators (Bipolar: -2, -1, 0, 1, 2) */
    .indicator-segments {
      display: flex;
      gap: 3px;
      align-items: center;
      flex: 1;
    }
    .indicator-segment {
      flex: 1;
      height: 8px;
      border-radius: 4px;
      background: #d1cfc4;
      transition: all 0.3s ease;
    }
    .indicator-segment.zero {
      width: 8px;
      height: 8px;
      flex: 0 0 8px;
      background: #d1cfc4;
      border-radius: 50%;
    }
    .dark .indicator-segment {
      background: #373737;
    }
    .dark .indicator-segment.zero {
      background: #373737;
    }
    .indicator-segment.active {
      background: var(--accent-color);
      box-shadow: 0 0 6px var(--accent-glow-soft);
    }
    .indicator-segment.zero.active {
      background: var(--accent-color);
      box-shadow: 0 0 6px var(--accent-glow-soft);
    }

    /* Icon Indicators */
    .icon-indicator {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .icon-indicator .material-icons-round {
      font-size: 20px;
      color: #d1cfc4;
      transition: all 0.3s ease;
    }
    .dark .icon-indicator .material-icons-round {
      color: #373737;
    }
    .icon-indicator .material-icons-round.active {
      color: var(--accent-color);
      text-shadow: 0 0 8px var(--accent-glow);
    }

    /* Alignment Quality - larger icons */
    #logic-alignment-icons .material-icons-round {
      font-size: 42px;
      color: #d1cfc4;
      transition: all 0.3s ease;
    }
    .dark #logic-alignment-icons .material-icons-round {
      color: #373737;
    }
    #logic-alignment-icons .material-icons-round.active {
      color: var(--accent-color);
      text-shadow: 0 0 12px var(--accent-glow);
      transform: scale(1.1);
    }

    /* Signal Strength - larger icons */
    #logic-signal-icons .material-icons-round {
      font-size: 42px;
      color: #d1cfc4;
      transition: all 0.3s ease;
    }
    .dark #logic-signal-icons .material-icons-round {
      color: #373737;
    }
    #logic-signal-icons .material-icons-round.active {
      color: var(--accent-color);
      text-shadow: 0 0 12px var(--accent-glow);
      transform: scale(1.1);
    }

    /* Expandable Header */
    .header-expandable {
      transition: all 0.3s ease;
    }

    .header-timeframe-row {
      transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
      max-height: 200px;
      opacity: 1;
    }

    .header-timeframe-row.hidden {
      max-height: 0;
      opacity: 0;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      overflow: hidden;
    }

    /* Header compact mode */
    .header-expandable.compact .header-timeframe-row {
      padding-bottom: 0.75rem !important;
    }

    .header-expandable.compact .timeframe-selector {
      padding: 1.5rem !important;
    }

    /* Adjust main padding based on header state */
    main {
      transition: padding-top 0.3s ease;
    }

    body.dashboard-active main {
      padding-top: 280px;
    }

    body.dashboard-active.header-compact main {
      padding-top: 160px;
    }

    /* Collapsible content inside cards */
    .tf-collapsible {
      max-height: 150px;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
      opacity: 1;
    }

    /* Compact mode - collapse the bottom content */
    .header-expandable.compact .tf-collapsible {
      max-height: 0;
      opacity: 0;
      margin-top: 0 !important;
      margin-bottom: 0 !important;
    }

    .header-expandable.compact .tf-label {
      margin-bottom: 0 !important;
    }

    /* Selected card emphasis in compact mode */
    .header-expandable.compact .logic-tf-card.selected .tf-label {
      color: var(--accent-color);
      text-shadow: 0 0 12px var(--accent-glow);
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark transition-colors duration-300 min-h-screen">

  <div class="loading-overlay bg-background-light dark:bg-background-dark" id="loadingOverlay">
    <div class="spinner"></div>
    <p class="mt-4 text-sm font-semibold text-text-sub-light dark:text-text-sub-dark">Loading...</p>
  </div>

  <header class="fixed top-0 left-0 right-0 z-50 bg-background-light dark:bg-background-dark header-expandable" id="mainHeader">
    <div class="max-w-4xl mx-auto px-4">
      <!-- Top row: Protocol name + Navigation -->
      <div class="flex items-center justify-between py-3">
        <!-- Protocol Name (left side) -->
        <div class="flex items-center cursor-pointer pl-2 md:pl-0" onclick="navigateTo('home')">
          <h1 class="text-base md:text-base lg:text-lg font-bold title-monospace" style="word-spacing: -0.2em; letter-spacing: 0.02em;">
            <span class="text-text-main-light dark:text-text-main-dark">The</span>
            <span class="ml-0.5" id="header-anomaly-word"></span>
            <span class="text-text-main-light dark:text-text-main-dark ml-0.5">Protocol</span>
          </h1>
        </div>

        <!-- Right side: Navigation + Theme toggle -->
        <div class="flex items-center space-x-2">
          <!-- Navigation (always visible) -->
          <nav class="flex items-center space-x-2">
          <span onclick="navigateTo('home')" data-page="home" class="nav-item active w-10 h-10 rounded-xl flex items-center justify-center cursor-pointer shadow-neu-icon-light dark:shadow-neu-icon-dark hover:shadow-neu-pressed-light dark:hover:shadow-neu-pressed-dark transition-shadow bg-background-light dark:bg-background-dark">
            <span class="material-icons-round text-xl">home</span>
          </span>
          <span onclick="navigateTo('dashboard')" data-page="dashboard" class="nav-item w-10 h-10 rounded-xl flex items-center justify-center cursor-pointer shadow-neu-icon-light dark:shadow-neu-icon-dark hover:shadow-neu-pressed-light dark:hover:shadow-neu-pressed-dark transition-shadow bg-background-light dark:bg-background-dark">
            <span class="material-icons-round text-text-sub-light dark:text-text-sub-dark text-xl">dashboard</span>
          </span>
          <span onclick="navigateTo('info')" data-page="info" class="nav-item w-10 h-10 rounded-xl flex items-center justify-center cursor-pointer shadow-neu-icon-light dark:shadow-neu-icon-dark hover:shadow-neu-pressed-light dark:hover:shadow-neu-pressed-dark transition-shadow bg-background-light dark:bg-background-dark">
            <span class="text-text-sub-light dark:text-text-sub-dark text-xl font-bold" style="font-family: 'Roboto Slab', serif;">i</span>
          </span>
        </nav>

          <!-- Theme toggle (always on the right) -->
          <button onclick="cycleColorTheme()" class="w-10 h-10 rounded-xl flex items-center justify-center shadow-neu-icon-light dark:shadow-neu-icon-dark hover:shadow-neu-pressed-light dark:hover:shadow-neu-pressed-dark transition-shadow bg-background-light dark:bg-background-dark">
            <span class="material-icons-round text-text-sub-light dark:text-text-sub-dark text-xl">brush</span>
          </button>
        </div>
      </div>

      <!-- Timeframe Selector Row (only visible in dashboard) -->
      <div class="header-timeframe-row hidden pb-3" id="headerTimeframeRow">
        <div class="w-full p-6 rounded-[2rem] shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark timeframe-selector" id="timeframeSelector" style="margin-left: -1rem; margin-right: -1rem; width: calc(100% + 2rem);">
          <div class="grid grid-cols-3 gap-3" id="timeframeGrid">
            <!-- Timeframe cards will be moved here -->
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="pt-20 pb-28 px-4">
    <div class="max-w-4xl mx-auto">

      <!-- HOME PAGE -->
      <section id="page-home" class="page-section active">
        <!-- Chart -->
        <div class="mb-8">
          <div class="p-6 rounded-[2rem] shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark">
            <!-- Project Title - Mobile Only -->
            <div class="mb-4 text-left lg:hidden">
              <p class="text-base md:text-xl font-bold mb-0 text-primary-glow" id="typewriter-mobile"></p>
            </div>
            <div class="flex flex-col lg:flex-row justify-between items-center mb-4 gap-3 lg:gap-4">
              <div class="flex items-center space-x-3">
                <div class="hidden lg:flex w-10 h-10 rounded-full shadow-neu-pressed-light dark:shadow-neu-pressed-dark items-center justify-center text-primary-glow">
                  <span class="material-icons-round">insights</span>
                </div>
                <div>
                  <h3 class="text-base font-bold">PNL Equity Line</h3>
                  <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 rounded-full live-pulse"></div>
                    <span class="text-xs font-bold text-primary-glow" id="home-data-status">LIVE</span>
                    <span class="text-xs font-semibold text-text-sub-light dark:text-text-sub-dark">uptime <span id="home-header-uptime">--</span></span>
                  </div>
                </div>
              </div>
              <!-- Project Title - Desktop Only -->
              <div class="hidden lg:block flex-1 text-left px-4">
                <p class="text-lg font-bold text-primary-glow whitespace-nowrap" id="typewriter-desktop"></p>
              </div>
              <div class="flex space-x-2">
                <button class="timeframe-btn px-3 py-1.5 rounded-xl text-[10px] font-bold shadow-neu-pressed-light dark:shadow-neu-pressed-dark text-primary-glow bg-background-light dark:bg-background-dark active" data-timeframe="ALL">ALL</button>
                <button class="timeframe-btn px-3 py-1.5 rounded-xl text-[10px] font-bold shadow-neu-flat-light dark:shadow-neu-flat-dark text-text-sub-light dark:text-text-sub-dark hover:text-primary-glow transition-colors bg-background-light dark:bg-background-dark" data-timeframe="1M">1M</button>
                <button class="timeframe-btn px-3 py-1.5 rounded-xl text-[10px] font-bold shadow-neu-flat-light dark:shadow-neu-flat-dark text-text-sub-light dark:text-text-sub-dark hover:text-primary-glow transition-colors bg-background-light dark:bg-background-dark" data-timeframe="1W">1W</button>
              </div>
            </div>
            <div class="h-64 md:h-80 lg:h-96">
              <canvas id="pnlChart"></canvas>
            </div>

            <!-- Latest Trade Section -->
            <div class="mt-6 pt-6 relative">
              <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-text-sub-light dark:via-text-sub-dark to-transparent opacity-30"></div>
              <div class="flex items-center space-x-3 mb-3">
                <div class="w-10 h-10 rounded-full shadow-neu-pressed-light dark:shadow-neu-pressed-dark flex items-center justify-center text-primary-glow">
                  <span class="material-icons-round">swap_horiz</span>
                </div>
                <div>
                  <h3 class="text-base font-bold">Latest Trade: <span class="text-primary-glow" id="home-latest-trade-action">--</span></h3>
                  <p class="text-xs text-primary-glow" id="home-latest-trade-date">--</p>
                </div>
              </div>
              <p class="text-sm text-text-sub-light dark:text-text-sub-dark leading-relaxed" id="home-latest-trade">Loading...</p>
            </div>
          </div>
        </div>

        <!-- Trade Details Cards -->
        <div class="mb-8">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 rounded-2xl shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark">
              <div class="flex items-center space-x-2 mb-2">
                <span class="text-sm font-extrabold text-primary-glow" style="font-family: 'Nunito', sans-serif;">! !</span>
                <span class="text-xs font-bold">Risk</span>
              </div>
              <p class="text-[13px] text-text-sub-light dark:text-text-sub-dark leading-relaxed" id="home-data-risk">--</p>
            </div>
            <div class="p-4 rounded-2xl shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark">
              <div class="flex items-center space-x-2 mb-2">
                <span class="material-icons-round text-sm text-primary-glow">bar_chart</span>
                <span class="text-xs font-bold">Market</span>
              </div>
              <p class="text-[13px] text-text-sub-light dark:text-text-sub-dark leading-relaxed" id="home-data-market">--</p>
            </div>
            <div class="p-4 rounded-2xl shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark">
              <div class="flex items-center space-x-2 mb-2">
                <span class="material-icons-round text-sm text-primary-glow">bolt</span>
                <span class="text-xs font-bold">Execution</span>
              </div>
              <p class="text-[13px] text-text-sub-light dark:text-text-sub-dark leading-relaxed" id="home-data-summary">--</p>
            </div>
          </div>
        </div>
      </section>

      <!-- DASHBOARD PAGE (unified wallet + logic) -->
      <section id="page-dashboard" class="page-section">

        <!-- Timeframe Selector (Granularity) - Sticky on scroll -->
        <div class="mb-6 timeframe-sticky-wrapper" id="timeframeStickyWrapper">
          <div class="p-4 rounded-[2rem] shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark timeframe-selector" id="timeframeSelector">
            <div class="grid grid-cols-3 gap-3">
              <!-- Daily -->
              <div class="p-3 rounded-xl text-center logic-tf-card shadow-neu-flat-light dark:shadow-neu-flat-dark cursor-pointer selected" data-tf="daily">
                <p class="text-sm font-bold tracking-wide mb-2 tf-label" id="tf-daily-label">Daily</p>
                <div class="tf-collapsible">
                  <span class="material-icons-round text-3xl mb-2 text-text-sub-light dark:text-text-sub-dark" id="tf-daily-icon">--</span>
                  <p class="text-sm font-bold mb-2" id="tf-daily-dir">--</p>
                  <div class="flex justify-center gap-1 mb-1" id="tf-daily-confidence">
                    <div class="indicator-dot small"></div>
                    <div class="indicator-dot small"></div>
                    <div class="indicator-dot small"></div>
                  </div>
                  <p class="text-[10px] font-semibold text-text-sub-light dark:text-text-sub-dark" id="tf-daily-conf-text">--</p>
                </div>
              </div>
              <!-- Weekly -->
              <div class="p-3 rounded-xl text-center logic-tf-card shadow-neu-flat-light dark:shadow-neu-flat-dark cursor-pointer" data-tf="weekly">
                <p class="text-sm font-bold tracking-wide text-text-sub-light dark:text-text-sub-dark mb-2 tf-label" id="tf-weekly-label">Weekly</p>
                <div class="tf-collapsible">
                  <span class="material-icons-round text-3xl mb-2 text-text-sub-light dark:text-text-sub-dark" id="tf-weekly-icon">--</span>
                  <p class="text-sm font-bold text-text-sub-light dark:text-text-sub-dark mb-2" id="tf-weekly-dir">--</p>
                  <div class="flex justify-center gap-1 mb-1" id="tf-weekly-confidence">
                    <div class="indicator-dot small"></div>
                    <div class="indicator-dot small"></div>
                    <div class="indicator-dot small"></div>
                  </div>
                  <p class="text-[10px] font-semibold text-text-sub-light dark:text-text-sub-dark" id="tf-weekly-conf-text">--</p>
                </div>
              </div>
              <!-- Monthly -->
              <div class="p-3 rounded-xl text-center logic-tf-card shadow-neu-flat-light dark:shadow-neu-flat-dark cursor-pointer" data-tf="monthly">
                <p class="text-sm font-bold tracking-wide text-text-sub-light dark:text-text-sub-dark mb-2 tf-label" id="tf-monthly-label">Monthly</p>
                <div class="tf-collapsible">
                  <span class="material-icons-round text-3xl mb-2 text-text-sub-light dark:text-text-sub-dark" id="tf-monthly-icon">--</span>
                  <p class="text-sm font-bold text-text-sub-light dark:text-text-sub-dark mb-2" id="tf-monthly-dir">--</p>
                  <div class="flex justify-center gap-1 mb-1" id="tf-monthly-confidence">
                    <div class="indicator-dot small"></div>
                    <div class="indicator-dot small"></div>
                    <div class="indicator-dot small"></div>
                  </div>
                  <p class="text-[10px] font-semibold text-text-sub-light dark:text-text-sub-dark" id="tf-monthly-conf-text">--</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Wallet Overview -->
        <div class="mb-6 content-below-selector">
          <div class="p-6 rounded-[2rem] shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark">
            <div class="text-center mb-4">
              <span class="text-xs font-bold uppercase tracking-wider text-text-sub-light dark:text-text-sub-dark">Wallet Balance</span>
              <p class="text-3xl font-extrabold text-primary-glow" id="data-value">$0.00</p>
            </div>
            <!-- Stats: Side, PNL, APY, Leverage -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
              <div class="p-3 rounded-xl shadow-neu-pressed-light dark:shadow-neu-pressed-dark bg-background-light dark:bg-background-dark text-center">
                <p class="text-[10px] font-bold uppercase tracking-wider text-text-sub-light dark:text-text-sub-dark">Side</p>
                <p class="text-lg font-extrabold text-primary-glow" id="data-side">--</p>
              </div>
              <div class="p-3 rounded-xl shadow-neu-pressed-light dark:shadow-neu-pressed-dark bg-background-light dark:bg-background-dark text-center">
                <p class="text-[10px] font-bold uppercase tracking-wider text-text-sub-light dark:text-text-sub-dark">PNL</p>
                <p class="text-lg font-extrabold text-primary-glow" id="data-pnl">--</p>
              </div>
              <div class="p-3 rounded-xl shadow-neu-pressed-light dark:shadow-neu-pressed-dark bg-background-light dark:bg-background-dark text-center">
                <p class="text-[10px] font-bold uppercase tracking-wider text-text-sub-light dark:text-text-sub-dark">APY</p>
                <p class="text-lg font-extrabold text-primary-glow" id="data-apy">--</p>
              </div>
              <div class="p-3 rounded-xl shadow-neu-pressed-light dark:shadow-neu-pressed-dark bg-background-light dark:bg-background-dark text-center">
                <p class="text-[10px] font-bold uppercase tracking-wider text-text-sub-light dark:text-text-sub-dark">Leverage</p>
                <p class="text-lg font-extrabold text-primary-glow" id="data-lev">--</p>
              </div>
            </div>
            <!-- Progress Bars -->
            <div class="progress-container mt-8">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xs font-bold text-text-main-light dark:text-text-main-dark">Margin</span>
                  <span class="text-xs font-bold text-primary-glow" id="data-mrg">0%</span>
                </div>
                <div class="progress-track mb-2">
                  <div class="progress-fill" id="data-mrg-bar" style="width: 0%"></div>
                </div>
                <p class="text-[10px] text-text-sub-light dark:text-text-sub-dark">margin consumed by the BTC position specifically</p>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xs font-bold text-text-main-light dark:text-text-main-dark">Liquidation</span>
                  <span class="text-xs font-bold text-primary-glow" id="data-liq">0%</span>
                </div>
                <div class="progress-track mb-2">
                  <div class="progress-fill" id="data-liq-bar" style="width: 0%"></div>
                </div>
                <p class="text-[10px] text-text-sub-light dark:text-text-sub-dark">distance between the current market price and the liquidation threshold price</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Thesis Section -->
        <div class="mb-6">
          <div class="p-6 rounded-[2rem] shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark">
            <div class="flex items-center space-x-3 mb-4">
              <div class="w-10 h-10 rounded-full shadow-neu-pressed-light dark:shadow-neu-pressed-dark flex items-center justify-center text-primary-glow">
                <span class="material-icons-round">app_registration</span>
              </div>
              <div>
                <h3 class="text-base font-bold">Thesis</h3>
                <p class="text-xs text-primary-glow">summary of the timeframe signal and its implication</p>
              </div>
            </div>
            <p class="text-sm text-text-sub-light dark:text-text-sub-dark leading-relaxed" id="logic-thesis">Loading market thesis...</p>
          </div>
        </div>

        <!-- Key Indicators Grid -->
        <div class="mb-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Regime Bias -->
            <div class="p-5 rounded-2xl shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark">
              <div class="flex items-center space-x-2 mb-3">
                <span class="material-icons-round text-base text-primary-glow">balance</span>
                <span class="text-sm font-bold">Regime Bias</span>
                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center" style="border-color: #5a5a5a;">
                  <span class="text-xs font-bold text-primary-glow leading-none" id="logic-regime-value">--</span>
                </div>
              </div>
              <div class="indicator-segments mb-3" id="logic-regime-segments">
                <div class="indicator-segment" data-value="-2"></div>
                <div class="indicator-segment" data-value="-1"></div>
                <div class="indicator-segment zero" data-value="0"></div>
                <div class="indicator-segment" data-value="1"></div>
                <div class="indicator-segment" data-value="2"></div>
              </div>
              <div class="text-xs mt-2">
                <span class="font-semibold text-primary-glow">structural backdrop</span>
                <span class="text-text-sub-light dark:text-text-sub-dark"> degree to which the newsflow reinforces a broader bullish/bearish regime</span>
              </div>
            </div>

            <!-- News Momentum Score -->
            <div class="p-5 rounded-2xl shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark">
              <div class="flex items-center space-x-2 mb-3">
                <span class="material-icons-round text-base text-primary-glow">newspaper</span>
                <span class="text-sm font-bold">News Score</span>
                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center" style="border-color: #5a5a5a;">
                  <span class="text-xs font-bold text-primary-glow leading-none" id="logic-news-value">--</span>
                </div>
              </div>
              <div class="indicator-segments mb-3" id="logic-news-segments">
                <div class="indicator-segment" data-value="-2"></div>
                <div class="indicator-segment" data-value="-1"></div>
                <div class="indicator-segment zero" data-value="0"></div>
                <div class="indicator-segment" data-value="1"></div>
                <div class="indicator-segment" data-value="2"></div>
              </div>
              <div class="text-xs mt-2">
                <span class="font-semibold text-primary-glow">more tactical than regime</span>
                <span class="text-text-sub-light dark:text-text-sub-dark"> directional impulse of the newsflow within the timeframe</span>
              </div>
            </div>

            <!-- Signal Strength -->
            <div class="p-5 rounded-2xl shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark flex flex-col items-center justify-center">
              <div class="text-center mb-1">
                <span class="text-sm font-bold text-text-main-light dark:text-text-main-dark">Signal Strength</span>
              </div>
              <div class="text-center mb-3">
                <span class="text-xs text-text-sub-light dark:text-text-sub-dark">how clean the net directional signal is</span>
              </div>
              <div class="flex justify-center items-center gap-4 md:gap-6 mb-2" id="logic-signal-icons">
                <span class="material-icons-round" data-level="weak" title="Weak">star_border</span>
                <span class="material-icons-round" data-level="moderate" title="Moderate">star_half</span>
                <span class="material-icons-round" data-level="strong" title="Strong">star</span>
                <span class="material-icons-round" data-level="very_strong" title="Very Strong">stars</span>
              </div>
              <div class="text-center">
                <span class="text-sm font-semibold text-primary-glow" id="logic-signal-text">--</span>
              </div>
            </div>

            <!-- Alignment Quality -->
            <div class="p-5 rounded-2xl shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark flex flex-col items-center justify-center">
              <div class="text-center mb-1">
                <span class="text-sm font-bold text-text-main-light dark:text-text-main-dark">Alignment Quality</span>
              </div>
              <div class="text-center mb-3">
                <span class="text-xs text-text-sub-light dark:text-text-sub-dark">consistency between regime and momentum</span>
              </div>
              <div class="flex justify-center items-center gap-4 md:gap-8 mb-2" id="logic-alignment-icons">
                <span class="material-icons-round" data-state="unclear" title="Unclear">help_outline</span>
                <span class="material-icons-round" data-state="conflicting" title="Conflicting">sync_problem</span>
                <span class="material-icons-round" data-state="aligned" title="Aligned">check</span>
              </div>
              <div class="text-center">
                <span class="text-sm font-semibold text-primary-glow" id="logic-alignment-text">--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Signal Attribution -->
        <div class="mb-6">
          <div class="p-6 rounded-[2rem] shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark">
            <div class="flex items-center space-x-3 mb-4">
              <div class="w-10 h-10 rounded-full shadow-neu-pressed-light dark:shadow-neu-pressed-dark flex items-center justify-center text-primary-glow">
                <span class="material-icons-round">device_hub</span>
              </div>
              <div>
                <h3 class="text-base font-bold">Signal Attribution</h3>
                <p class="text-xs text-primary-glow">events driving the timeframe thesis</p>
              </div>
            </div>

            <!-- Key Events Section -->
            <div class="mb-4">
              <div class="flex items-center space-x-2 mb-3">
                <span class="material-icons-round text-sm text-primary-glow">event</span>
                <span class="text-sm font-bold">Key Events</span>
              </div>
              <ul class="space-y-2" id="logic-events">
                <li class="text-sm text-text-sub-light dark:text-text-sub-dark">Loading...</li>
              </ul>
            </div>

            <!-- Separator -->
            <div class="relative my-4">
              <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-text-sub-light dark:via-text-sub-dark to-transparent opacity-30"></div>
            </div>

            <!-- Dominant Narratives Section -->
            <div class="mt-6">
              <div class="flex items-center space-x-2 mb-3">
                <span class="material-icons-round text-sm text-primary-glow">auto_stories</span>
                <span class="text-sm font-bold">Dominant Narratives</span>
              </div>
              <div class="flex flex-wrap gap-x-4 gap-y-1" id="logic-narratives">
                <span class="text-sm text-text-sub-light dark:text-text-sub-dark">Loading...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Neural Framework -->
        <div class="mb-6">
          <div class="p-6 rounded-[2rem] shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark">
            <div class="flex items-center space-x-3 mb-4">
              <div class="w-10 h-10 rounded-full shadow-neu-pressed-light dark:shadow-neu-pressed-dark flex items-center justify-center text-primary-glow">
                <span class="material-icons-round">psychology</span>
              </div>
              <div>
                <h3 class="text-base font-bold">Neural Framework</h3>
                <p class="text-xs text-primary-glow">model logic behind the scores</p>
              </div>
            </div>
            <p class="text-sm text-text-sub-light dark:text-text-sub-dark leading-relaxed whitespace-pre-line" id="cot-summary">Loading neural analysis...</p>
          </div>
        </div>

      </section>

      <!-- INFO PAGE -->
      <section id="page-info" class="page-section">
        <!-- Design Philosophy -->
        <div class="p-6 rounded-[2rem] shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark">
          <div class="flex items-center space-x-3 mb-4">
            <div class="w-10 h-10 rounded-full shadow-neu-pressed-light dark:shadow-neu-pressed-dark flex items-center justify-center text-primary-glow">
              <span class="material-icons-round">auto_awesome</span>
            </div>
            <div>
              <h3 class="text-lg font-bold">Design Philosophy</h3>
              <p class="text-xs text-primary-glow">the next-gen trading engine</p>
            </div>
          </div>
          <div class="text-sm text-text-sub-light dark:text-text-sub-dark leading-relaxed space-y-4">
            <p>Anomaly is a market-adaptive trading system designed to outperform the underlying asset by maintaining continuous alignment with changing market conditions.</p>

            <p>Instead of operating through discrete trades, Anomaly follows a structural approach. It does not depend on traditional mechanisms such as entry signals, stop losses, or take profit levels. These concepts assume static decisions in a dynamic environment. Anomaly is built on a different assumption: that market conditions evolve continuously and must be managed as such.</p>

            <p>For this reason, the system remains permanently exposed to the market. It is always positioned, either long or short, and expresses its directional conviction through dynamic adjustment of exposure rather than through position closure. Leverage is increased when conditions strengthen, reduced when coherence weakens, and reversed when the underlying market structure changes.</p>

            <p>This design shifts the focus from trade execution to exposure management. Instead of reacting to specific price levels, Anomaly monitors transitions in market behavior and adapts its positioning accordingly. The outcome is not a sequence of isolated trades, but a single, continuously evolving position that reflects the current state of the market.</p>

            <p>Anomaly does not aim to predict individual moves or optimize entry timing. Its objective is relative performance: capturing value across both expansion and contraction phases of the market by remaining consistently aligned with structural change.</p>

            <p>In this sense, Anomaly is not a conventional trading strategy, but a technological framework for sustained market engagement.</p>
          </div>
        </div>
      </section>

    </div>
  </main>

  <footer class="fixed bottom-0 left-0 right-0 py-3 px-4 shadow-neu-flat-light dark:shadow-neu-flat-dark bg-background-light dark:bg-background-dark">
    <div class="max-w-4xl mx-auto text-center">
      <p class="text-xs text-text-sub-light dark:text-text-sub-dark">&copy; 2026 Anomaly Trading Systems &middot; <a href="https://www.zerox.technology" target="_blank" class="text-primary-glow hover:underline transition-all">www.zerox.technology</a></p>
    </div>
  </footer>

  <script>
    // Page Navigation
    function navigateTo(page) {
      document.querySelectorAll('.page-section').forEach(function(section) {
        section.classList.remove('active');
      });
      document.getElementById('page-' + page).classList.add('active');

      // Update active state for navigation items
      document.querySelectorAll('.nav-item').forEach(function(item) {
        item.classList.remove('active');
      });
      document.querySelectorAll('.nav-item[data-page="' + page + '"]').forEach(function(item) {
        item.classList.add('active');
      });

      // Handle timeframe selector in header for dashboard
      var headerTimeframeRow = document.getElementById('headerTimeframeRow');
      var timeframeGrid = document.getElementById('timeframeGrid');
      var originalTimeframeWrapper = document.getElementById('timeframeStickyWrapper');

      if (page === 'dashboard') {
        // Move timeframe cards to header
        document.body.classList.add('dashboard-active');
        document.body.classList.remove('header-compact');

        if (originalTimeframeWrapper && timeframeGrid) {
          var cards = originalTimeframeWrapper.querySelectorAll('.logic-tf-card');
          timeframeGrid.innerHTML = '';
          cards.forEach(function(card) {
            timeframeGrid.appendChild(card.cloneNode(true));
          });

          // Show header timeframe row
          headerTimeframeRow.classList.remove('hidden');

          // Hide original wrapper in page
          originalTimeframeWrapper.style.display = 'none';
        }

        // Refresh data
        if (typeof window.fetchLogicData === 'function') {
          window.fetchLogicData();
        }

        // Re-attach click handlers to cloned cards
        document.querySelectorAll('#timeframeGrid .logic-tf-card').forEach(function(card) {
          card.addEventListener('click', function() {
            var tf = this.dataset.tf;
            window.currentTimeframe = tf;

            document.querySelectorAll('.logic-tf-card').forEach(function(c) {
              c.classList.remove('selected');
            });
            this.classList.add('selected');

            if (window.logicData && window.logicData[window.currentTimeframe]) {
              window.updateLogicDisplay(window.logicData[window.currentTimeframe]);
            }
            window.updateTimeframeCards(window.logicData || {});
          });
        });
      } else {
        // Hide timeframe row for other pages
        document.body.classList.remove('dashboard-active', 'header-compact');
        if (headerTimeframeRow) {
          headerTimeframeRow.classList.add('hidden');
        }
        if (originalTimeframeWrapper) {
          originalTimeframeWrapper.style.display = '';
        }
      }

      window.scrollTo(0, 0);
    }

    // Color Theme System - 3 colors: orange, purple, green
    var colorThemes = {
      orange: { hex: '#FFB76A', r: 255, g: 183, b: 106 },
      purple: { hex: '#9696FF', r: 150, g: 150, b: 255 },
      green: { hex: '#01F0B9', r: 1, g: 240, b: 185 }
    };
    var themeOrder = ['orange', 'purple', 'green'];
    var currentThemeIdx = 0;

    function applyColorTheme(themeName) {
      var theme = colorThemes[themeName];
      if (!theme) return;
      var root = document.documentElement;

      // Only update CSS variables - no inline styles!
      // CSS variables propagate automatically to all elements
      root.style.setProperty('--accent-color', theme.hex);
      root.style.setProperty('--accent-r', theme.r);
      root.style.setProperty('--accent-g', theme.g);
      root.style.setProperty('--accent-b', theme.b);
      root.style.setProperty('--accent-glow', 'rgba(' + theme.r + ',' + theme.g + ',' + theme.b + ',0.8)');
      root.style.setProperty('--accent-glow-soft', 'rgba(' + theme.r + ',' + theme.g + ',' + theme.b + ',0.4)');

      // Update chart if exists (Chart.js doesn't use CSS variables)
      if (window.pnlChart) { window.pnlChart.destroy(); initChart(); }
    }

    function cycleColorTheme() {
      currentThemeIdx = (currentThemeIdx + 1) % themeOrder.length;
      var nextTheme = themeOrder[currentThemeIdx];
      applyColorTheme(nextTheme);
      localStorage.setItem('colorTheme', nextTheme);
    }

    // Always dark mode + load saved color theme
    document.documentElement.classList.add('dark');
    var savedTheme = localStorage.getItem('colorTheme') || 'orange';
    currentThemeIdx = themeOrder.indexOf(savedTheme);
    if (currentThemeIdx === -1) currentThemeIdx = 0;

    // Apply theme after DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() { applyColorTheme(savedTheme); });
    } else {
      applyColorTheme(savedTheme);
    }

    (function() {
      if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
      window.scrollTo(0, 0);

      var API_URL = 'https://305b3ad600d3.ngrok-free.app/webhook/wallet';
      var CHART_API_URL = 'https://305b3ad600d3.ngrok-free.app/webhook/chart';
      var loadingOverlay = document.getElementById('loadingOverlay');

      function hideLoading() {
        loadingOverlay.classList.add('hidden');
        // Emit event to signal data has loaded
        window.dispatchEvent(new Event('dataLoaded'));
      }
      function showError() {
        document.getElementById('home-data-status').textContent = 'ERROR';
        document.getElementById('home-data-status').style.color = '#64748B';
        hideLoading();
      }

      function populateData(data) {
        var d = Array.isArray(data) ? data[0] : data;
        if (!d) { showError(); return; }
        document.getElementById('data-value').textContent = d.value || '';
        document.getElementById('data-side').textContent = d.side || '';
        document.getElementById('home-header-uptime').textContent = d.uptime || '--';
        document.getElementById('data-pnl').textContent = d.pnl || '';
        document.getElementById('data-apy').textContent = d.apy || '--';
        document.getElementById('data-lev').textContent = d.lev || '';
        document.getElementById('data-mrg').textContent = d.mrg || '';
        document.getElementById('data-liq').textContent = d.liq || '';
        document.getElementById('home-data-risk').textContent = d.risk || '--';
        document.getElementById('home-data-market').textContent = d.market || '--';
        document.getElementById('home-data-summary').textContent = d.summary || '--';
        document.getElementById('home-latest-trade').textContent = d.summary || 'No trade summary available';
        document.getElementById('home-latest-trade-date').textContent = d.last || '--';
        document.getElementById('home-latest-trade-action').textContent = d.action || '--';
        document.getElementById('data-mrg-bar').style.width = (parseInt(d.mrg) || 0) + '%';
        document.getElementById('data-liq-bar').style.width = (parseInt(d.liq) || 0) + '%';
        document.getElementById('home-data-status').textContent = 'LIVE';
        hideLoading();
      }

      fetch(API_URL, { headers: { 'ngrok-skip-browser-warning': 'true' } })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(populateData)
        .catch(showError);

      window.fetchChartData = function(tf) {
        var url = tf && tf !== 'ALL' ? CHART_API_URL + '?timeframe=' + tf.toLowerCase() : CHART_API_URL;
        fetch(url, { headers: { 'ngrok-skip-browser-warning': 'true' } })
          .then(r => r.json())
          .then(function(data) {
            if (!window.pnlChart || !data.labels) return;
            window.pnlChart.data.labels = data.labels.map(function(ts) {
              var d = new Date(ts);
              return (d.getMonth()+1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + (d.getMinutes()<10?'0':'') + d.getMinutes();
            });
            window.pnlChart.data.datasets[0].data = data.values;
            window.pnlChart.update();
          });
      };

      window.initChart = function() {
        var ctx = document.getElementById('pnlChart').getContext('2d');
        var isDark = document.documentElement.classList.contains('dark');

        // Get current theme colors
        var currentTheme = colorThemes[themeOrder[currentThemeIdx]];
        var accentColor = currentTheme.hex;
        var glowColor = 'rgba(' + currentTheme.r + ',' + currentTheme.g + ',' + currentTheme.b + ',0.8)';
        var textColor = isDark ? '#e0e0e0' : '#4a4a4a';
        var subColor = isDark ? '#a0a0a0' : '#8d8d8d';
        var gridColor = isDark ? 'rgba(160,160,160,0.1)' : 'rgba(141,141,141,0.15)';
        var bgColor = isDark ? '#292929' : '#efeee9';

        var gradient = ctx.createLinearGradient(0, 0, 0, 280);
        gradient.addColorStop(0, 'rgba(' + currentTheme.r + ',' + currentTheme.g + ',' + currentTheme.b + ',0.3)');
        gradient.addColorStop(1, 'rgba(' + currentTheme.r + ',' + currentTheme.g + ',' + currentTheme.b + ',0)');

        var pulseTime = 0;
        var glowPlugin = {
          id: 'pointGlow',
          afterDatasetsDraw: function(chart) {
            var ctx = chart.ctx;
            chart.data.datasets.forEach(function(dataset, i) {
              var meta = chart.getDatasetMeta(i);
              if (!meta.hidden && meta.data.length > 0) {
                var lastIndex = meta.data.length - 1;

                // Draw last point with pulse effect
                if (meta.data[lastIndex]) {
                  var element = meta.data[lastIndex];
                  var pulse = Math.sin(Date.now() * 0.002) * 0.5 + 0.5;
                  var scale = 1 + pulse * 0.4;

                  ctx.save();
                  ctx.shadowBlur = 12 + pulse * 8;
                  ctx.shadowColor = glowColor;
                  ctx.shadowOffsetX = 0;
                  ctx.shadowOffsetY = 0;
                  ctx.globalAlpha = 0.8 + pulse * 0.2;

                  ctx.beginPath();
                  ctx.arc(element.x, element.y, 5 * scale, 0, 2 * Math.PI);
                  ctx.fillStyle = accentColor;
                  ctx.fill();

                  ctx.restore();
                }
              }
            });
          }
        };

        // Animate the last point continuously
        setInterval(function() {
          if (window.pnlChart && !window.pnlChart.destroyed) {
            window.pnlChart.update('none');
          }
        }, 50);

        window.pnlChart = new Chart(ctx, {
          type: 'line',
          data: { labels: [], datasets: [{
            data: [],
            borderColor: accentColor,
            backgroundColor: gradient,
            borderWidth: 3,
            pointBackgroundColor: accentColor,
            pointBorderColor: bgColor,
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: accentColor,
            pointHoverBorderWidth: 3,
            tension: 0.4,
            fill: true,
            shadowBlur: 12,
            shadowColor: glowColor
          }]},
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
              padding: {
                right: 15,
                top: 10
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: bgColor,
                titleColor: textColor,
                bodyColor: accentColor,
                titleFont: { family: 'Nunito', size: 11, weight: '700' },
                bodyFont: { family: 'Nunito', size: 13, weight: '800' },
                padding: 10,
                cornerRadius: 8,
                borderColor: accentColor,
                borderWidth: 2,
                displayColors: false,
                callbacks: { label: c => '$' + c.parsed.y.toLocaleString() }
              }
            },
            scales: {
              x: {
                grid: { color: gridColor, drawBorder: false },
                ticks: { color: subColor, font: { family: 'Nunito', size: 9, weight: '600' }, maxTicksLimit: 5 }
              },
              y: {
                grid: { color: gridColor, drawBorder: false },
                ticks: {
                  color: subColor,
                  font: { family: 'Nunito', size: 9, weight: '600' },
                  callback: v => v >= 1000 ? '$' + (v/1000).toFixed(1) + 'K' : '$' + v
                }
              }
            },
            interaction: { mode: 'index', intersect: false }
          },
          plugins: [glowPlugin]
        });
        fetchChartData('ALL');

        // Setup timeframe buttons event listeners
        document.querySelectorAll('.timeframe-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.timeframe-btn').forEach(function(b) {
              b.classList.remove('shadow-neu-pressed-light', 'dark:shadow-neu-pressed-dark', 'text-primary-glow', 'active');
              b.classList.add('shadow-neu-flat-light', 'dark:shadow-neu-flat-dark', 'text-text-sub-light', 'dark:text-text-sub-dark');
            });
            this.classList.add('shadow-neu-pressed-light', 'dark:shadow-neu-pressed-dark', 'text-primary-glow', 'active');
            this.classList.remove('shadow-neu-flat-light', 'dark:shadow-neu-flat-dark', 'text-text-sub-light', 'dark:text-text-sub-dark');
            fetchChartData(this.dataset.timeframe);
          });
        });
      };

      window.addEventListener('DOMContentLoaded', initChart);
    })();

    // Text Scramble Effect for "Anomaly"
    (function() {
      var targetWord = 'Anomaly';
      var scrambleContainer = document.getElementById('scramble-word');
      var isAnimating = false;

      // Character set per lo scramble
      var characterSet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';

      // Configurazione animazione
      var duration = 3.0; // secondi - molto pi lento
      var speed = 0.08; // secondi per frame - rallentato

      function getRandomChar() {
        return characterSet[Math.floor(Math.random() * characterSet.length)];
      }

      function scramble() {
        if (isAnimating) return;
        isAnimating = true;

        // Crea uno span per ogni carattere
        scrambleContainer.innerHTML = '';
        var charSpans = [];
        var charRevealed = [];
        var charGlowApplied = [];

        for (var i = 0; i < targetWord.length; i++) {
          var span = document.createElement('span');
          span.textContent = targetWord[i];
          scrambleContainer.appendChild(span);
          charSpans.push(span);
          charRevealed.push(false);
          charGlowApplied.push(false);
        }

        var steps = duration / speed;
        var step = 0;

        var interval = setInterval(function() {
          var progress = step / steps;

          for (var i = 0; i < targetWord.length; i++) {
            if (targetWord[i] === ' ') {
              continue;
            }

            if (progress * targetWord.length > i) {
              // Lettera in fase di reveal

              // Applica glow con colore tema quando la lettera INIZIA lo scramble
              if (!charGlowApplied[i]) {
                (function(span) {
                  var theme = colorThemes[themeOrder[currentThemeIdx]];
                  var rgb = theme.r + ',' + theme.g + ',' + theme.b;
                  span.style.transition = 'none';
                  span.style.color = theme.hex;
                  span.style.textShadow = '0 0 12px rgba(' + rgb + ',1), 0 0 20px rgba(' + rgb + ',0.8)';

                  setTimeout(function() {
                    span.style.transition = 'text-shadow 0.3s ease-out';
                    span.style.textShadow = '0 0 4px rgba(' + rgb + ',0.5)';
                  }, 100);
                })(charSpans[i]);
                charGlowApplied[i] = true;
              }

              // Rivela la lettera finale
              if (!charRevealed[i]) {
                charSpans[i].textContent = targetWord[i];
                charRevealed[i] = true;

                // Inizia transizione verso il bianco
                (function(span) {
                  setTimeout(function() {
                    span.style.transition = 'color 10s ease-out, text-shadow 10s ease-out';
                    span.style.color = '';
                    span.style.textShadow = '';
                  }, 150);
                })(charSpans[i]);
              }
            } else {
              // Lettera ancora scrambled
              charSpans[i].textContent = getRandomChar();
            }
          }

          step++;

          if (step > steps) {
            clearInterval(interval);
            isAnimating = false;
          }
        }, speed * 1000);
      }

      window.addEventListener('DOMContentLoaded', function() {
        // Inizializza con gli span
        scrambleContainer.innerHTML = '';
        for (var i = 0; i < targetWord.length; i++) {
          var span = document.createElement('span');
          span.textContent = targetWord[i];
          scrambleContainer.appendChild(span);
        }

        // Avvia la prima animazione dopo un piccolo delay
        setTimeout(function() {
          scramble();
        }, 500);

        // Ripeti l'animazione ogni 15 secondi
        setInterval(function() {
          scramble();
        }, 15000);
      });
    })();

    // Header Anomaly Scramble Effect
    (function() {
      var targetWord = 'Anomaly';
      var scrambleContainer = document.getElementById('header-anomaly-word');
      var isAnimating = false;
      var characterSet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
      var duration = 3.0;
      var speed = 0.08;

      function getRandomChar() {
        return characterSet[Math.floor(Math.random() * characterSet.length)];
      }

      function scrambleHeader() {
        if (isAnimating) return;
        isAnimating = true;

        scrambleContainer.innerHTML = '';
        var charSpans = [];
        var charRevealed = [];
        var charGlowApplied = [];

        for (var i = 0; i < targetWord.length; i++) {
          var span = document.createElement('span');
          span.textContent = targetWord[i];
          scrambleContainer.appendChild(span);
          charSpans.push(span);
          charRevealed.push(false);
          charGlowApplied.push(false);
        }

        var steps = duration / speed;
        var step = 0;

        var interval = setInterval(function() {
          var progress = step / steps;

          for (var i = 0; i < targetWord.length; i++) {
            if (targetWord[i] === ' ') continue;

            if (progress * targetWord.length > i) {
              if (!charGlowApplied[i]) {
                (function(span) {
                  var theme = colorThemes[themeOrder[currentThemeIdx]];
                  var rgb = theme.r + ',' + theme.g + ',' + theme.b;
                  span.style.transition = 'none';
                  span.style.color = theme.hex;
                  span.style.textShadow = '0 0 12px rgba(' + rgb + ',1), 0 0 20px rgba(' + rgb + ',0.8)';

                  setTimeout(function() {
                    span.style.transition = 'text-shadow 0.3s ease-out';
                    span.style.textShadow = '0 0 4px rgba(' + rgb + ',0.5)';
                  }, 100);
                })(charSpans[i]);
                charGlowApplied[i] = true;
              }

              if (!charRevealed[i]) {
                charSpans[i].textContent = targetWord[i];
                charRevealed[i] = true;

                (function(span) {
                  setTimeout(function() {
                    span.style.transition = 'color 10s ease-out, text-shadow 10s ease-out';
                    span.style.color = '';
                    span.style.textShadow = '';
                  }, 150);
                })(charSpans[i]);
              }
            } else {
              charSpans[i].textContent = getRandomChar();
            }
          }

          step++;
          if (step > steps) {
            clearInterval(interval);
            isAnimating = false;
          }
        }, speed * 1000);
      }

      window.addEventListener('DOMContentLoaded', function() {
        scrambleContainer.innerHTML = '';
        for (var i = 0; i < targetWord.length; i++) {
          var span = document.createElement('span');
          span.textContent = targetWord[i];
          span.style.color = 'var(--accent-color)';
          scrambleContainer.appendChild(span);
        }

        setTimeout(function() {
          scrambleHeader();
        }, 800);

        setInterval(function() {
          scrambleHeader();
        }, 60000);
      });
    })();

    // Typewriter Effect for "Fully autonomous trading system agent"
    (function() {
      var fullText = 'Fully autonomous trading system agent';
      var mobileElement = document.getElementById('typewriter-mobile');
      var desktopElement = document.getElementById('typewriter-desktop');
      var speed = 50; // milliseconds per character
      var hasAnimated = false;

      function typewriter(element) {
        if (!element) return;

        var currentIndex = 0;
        element.textContent = '';

        function addChar() {
          if (currentIndex < fullText.length) {
            element.textContent += fullText[currentIndex];
            currentIndex++;
            setTimeout(addChar, speed);
          }
        }

        addChar();
      }

      function startTypewriter() {
        // Determine which element to animate based on screen size
        var isMobile = window.innerWidth < 1024; // lg breakpoint
        var targetElement = isMobile ? mobileElement : desktopElement;

        if (targetElement && !hasAnimated) {
          typewriter(targetElement);
          hasAnimated = true;
        }
      }

      // Start animation when home page becomes active AND data is loaded
      function checkHomePage() {
        var homePage = document.getElementById('page-home');
        if (homePage && homePage.classList.contains('active')) {
          startTypewriter();
        } else {
          // Reset when leaving home page
          hasAnimated = false;
          if (mobileElement) mobileElement.textContent = '';
          if (desktopElement) desktopElement.textContent = '';
        }
      }

      // Listen for data loaded event to start animation
      window.addEventListener('dataLoaded', function() {
        var homePage = document.getElementById('page-home');
        if (homePage && homePage.classList.contains('active')) {
          setTimeout(function() {
            startTypewriter();
          }, 300); // Small delay after data loads for smoother transition
        }
      });

      // Re-trigger when navigating back to home
      // Hook into the existing navigateTo function
      var originalNavigateTo = window.navigateTo;
      if (originalNavigateTo) {
        window.navigateTo = function(page) {
          originalNavigateTo(page);
          if (page === 'home') {
            // Reset animation state when navigating to home
            hasAnimated = false;
            // Check if data is already loaded (page was already visited)
            var loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay && loadingOverlay.classList.contains('hidden')) {
              // Data already loaded, start animation immediately
              setTimeout(checkHomePage, 300);
            }
            // Otherwise wait for dataLoaded event
          }
        };
      }
    })();

    // Logic Page Functionality
    (function() {
      var LOGIC_API_URL = 'https://305b3ad600d3.ngrok-free.app/webhook/logic';
      window.logicData = null;
      window.currentTimeframe = 'daily';

      // Get direction icon based on direction string
      function getDirectionIcon(direction) {
        if (!direction) return 'remove';
        var dir = direction.toLowerCase();
        if (dir === 'long' || dir.includes('bullish') || dir.includes('up')) return 'trending_up';
        if (dir === 'short' || dir.includes('bearish') || dir.includes('down')) return 'trending_down';
        if (dir === 'neutral' || dir.includes('flat') || dir.includes('sideways')) return 'trending_flat';
        return 'trending_flat';
      }

      // Get color class based on direction (always orange)
      function getDirectionColor(direction) {
        if (!direction) return 'text-text-sub-light dark:text-text-sub-dark';
        return 'text-primary-glow';
      }

      // Update the main display for selected timeframe
      window.updateLogicDisplay = function(tfData) {
        if (!tfData) return;

        // Indicators
        // Regime Bias (-2, -1, 0, 1, 2) - bipolar segments indicator
        var regimeBias = tfData.regimebias != null ? parseInt(tfData.regimebias) : 0;
        document.getElementById('logic-regime-value').textContent = regimeBias;
        var regimeSegs = document.querySelectorAll('#logic-regime-segments .indicator-segment');
        regimeSegs.forEach(function(seg) {
          var segValue = parseInt(seg.getAttribute('data-value'));
          if (regimeBias === 0 && segValue === 0) {
            seg.classList.add('active');
          } else if (regimeBias > 0 && segValue > 0 && segValue <= regimeBias) {
            seg.classList.add('active');
          } else if (regimeBias < 0 && segValue < 0 && segValue >= regimeBias) {
            seg.classList.add('active');
          } else {
            seg.classList.remove('active');
          }
        });

        // News Momentum Score (-2, -1, 0, 1, 2) - bipolar segments indicator
        var newsScore = tfData.newsmomentumscore != null ? parseInt(tfData.newsmomentumscore) : 0;
        document.getElementById('logic-news-value').textContent = newsScore;
        var newsSegs = document.querySelectorAll('#logic-news-segments .indicator-segment');
        newsSegs.forEach(function(seg) {
          var segValue = parseInt(seg.getAttribute('data-value'));
          if (newsScore === 0 && segValue === 0) {
            seg.classList.add('active');
          } else if (newsScore > 0 && segValue > 0 && segValue <= newsScore) {
            seg.classList.add('active');
          } else if (newsScore < 0 && segValue < 0 && segValue >= newsScore) {
            seg.classList.add('active');
          } else {
            seg.classList.remove('active');
          }
        });

        // Signal Strength (categorical) - single icon indicator
        var signalStrength = (tfData.signalstrength || '').toLowerCase().replace(/\s+/g, '_');
        document.getElementById('logic-signal-text').textContent = tfData.signalstrength || '--';
        var signalIcons = document.querySelectorAll('#logic-signal-icons .material-icons-round');
        signalIcons.forEach(function(icon) {
          if (icon.getAttribute('data-level') === signalStrength) {
            icon.classList.add('active');
          } else {
            icon.classList.remove('active');
          }
        });

        // Alignment Quality (aligned/conflicting/unclear) - single icon indicator
        var alignmentQuality = (tfData.alignmentquality || '').toLowerCase();
        document.getElementById('logic-alignment-text').textContent = tfData.alignmentquality || '--';
        var alignmentIcons = document.querySelectorAll('#logic-alignment-icons .material-icons-round');
        alignmentIcons.forEach(function(icon) {
          if (icon.getAttribute('data-state') === alignmentQuality) {
            icon.classList.add('active');
          } else {
            icon.classList.remove('active');
          }
        });

        // Thesis
        document.getElementById('logic-thesis').textContent = tfData.thesis || 'No thesis available';

        // Narratives - handle as comma-separated string (horizontal with bullet separators)
        var narrativesEl = document.getElementById('logic-narratives');
        if (tfData.dominantnarratives) {
          var narrativesArray = Array.isArray(tfData.dominantnarratives)
            ? tfData.dominantnarratives
            : tfData.dominantnarratives.split(',').map(function(s) { return s.trim(); });

          if (narrativesArray.length > 0) {
            narrativesEl.innerHTML = narrativesArray.map(function(n, idx) {
              var separator = idx < narrativesArray.length - 1 ? '<span class="text-primary-glow mx-2"></span>' : '';
              return '<span class="text-sm text-text-sub-light dark:text-text-sub-dark inline">' + n + '</span>' + separator;
            }).join('');
          } else {
            narrativesEl.innerHTML = '<span class="text-sm text-text-sub-light dark:text-text-sub-dark">No narratives available</span>';
          }
        } else {
          narrativesEl.innerHTML = '<span class="text-sm text-text-sub-light dark:text-text-sub-dark">No narratives available</span>';
        }

        // Events - handle as pipe-separated string
        var eventsEl = document.getElementById('logic-events');
        if (tfData.keyevents) {
          var eventsArray = Array.isArray(tfData.keyevents)
            ? tfData.keyevents
            : tfData.keyevents.split('|').map(function(s) { return s.trim(); });

          if (eventsArray.length > 0) {
            eventsEl.innerHTML = eventsArray.map(function(e) {
              return '<li class="text-sm text-text-sub-light dark:text-text-sub-dark flex items-start"><span class="text-primary-glow mr-2"></span>' + e + '</li>';
            }).join('');
          } else {
            eventsEl.innerHTML = '<li class="text-sm text-text-sub-light dark:text-text-sub-dark">No events available</li>';
          }
        } else {
          eventsEl.innerHTML = '<li class="text-sm text-text-sub-light dark:text-text-sub-dark">No events available</li>';
        }

        // COT - handle as plain text string
        if (tfData.cot) {
          document.getElementById('cot-summary').textContent = tfData.cot;
        } else {
          document.getElementById('cot-summary').textContent = 'No COT analysis available';
        }
      };

      // Update timeframe comparison cards
      window.updateTimeframeCards = function(data) {
        var timeframes = ['daily', 'weekly', 'monthly'];
        timeframes.forEach(function(tf) {
          var tfData = data[tf];
          var labelEl = document.getElementById('tf-' + tf + '-label');
          var iconEl = document.getElementById('tf-' + tf + '-icon');
          var dirEl = document.getElementById('tf-' + tf + '-dir');
          var cardEl = document.querySelector('.logic-tf-card[data-tf="' + tf + '"]');
          var confidenceEl = document.getElementById('tf-' + tf + '-confidence');
          var confTextEl = document.getElementById('tf-' + tf + '-conf-text');

          if (tfData) {
            // Always show data
            iconEl.textContent = getDirectionIcon(tfData.direction);
            dirEl.textContent = tfData.direction || '--';

            // Update confidence dots and text (3 dots: low, medium, high)
            var confidence = tfData.confidence || 0;
            var confidenceNum = 0;
            var confidenceText = '';
            var dotsToActivate = 0;

            if (typeof confidence === 'string') {
              var confLower = confidence.toLowerCase();
              confidenceText = confidence.charAt(0).toUpperCase() + confidence.slice(1);

              // Map to number of dots (1-3)
              if (confLower === 'low') {
                dotsToActivate = 1;
              } else if (confLower === 'medium') {
                dotsToActivate = 2;
              } else if (confLower === 'high') {
                dotsToActivate = 3;
              }
            }

            var dots = confidenceEl.querySelectorAll('.indicator-dot');

            // Update dots (always visible, but only active if selected)
            dots.forEach(function(dot, idx) {
              if (tf === window.currentTimeframe && idx < dotsToActivate) {
                dot.classList.add('active');
              } else {
                dot.classList.remove('active');
              }
            });

            // Color based on selection
            if (tf === window.currentTimeframe) {
              // Selected: label orange, pressed shadow
              cardEl.classList.add('shadow-neu-pressed-light', 'dark:shadow-neu-pressed-dark', 'selected');
              cardEl.classList.remove('shadow-neu-flat-light', 'dark:shadow-neu-flat-dark');

              labelEl.className = 'text-sm font-bold tracking-wide text-primary-glow mb-2 tf-label';
              iconEl.className = 'material-icons-round text-3xl mb-2 text-text-sub-light dark:text-text-sub-dark';
              dirEl.className = 'text-sm font-bold text-primary-glow mb-2';

              confTextEl.innerHTML = '<span class="text-text-sub-light dark:text-text-sub-dark">confidence </span><span class="text-primary-glow">' + confidenceText + '</span>';
            } else {
              // Not selected: everything gray
              cardEl.classList.remove('shadow-neu-pressed-light', 'dark:shadow-neu-pressed-dark', 'selected');
              cardEl.classList.add('shadow-neu-flat-light', 'dark:shadow-neu-flat-dark');

              labelEl.className = 'text-sm font-bold tracking-wide text-text-sub-light dark:text-text-sub-dark mb-2 tf-label';
              iconEl.className = 'material-icons-round text-3xl mb-2 text-text-sub-light dark:text-text-sub-dark';
              dirEl.className = 'text-sm font-bold text-text-sub-light dark:text-text-sub-dark mb-2';

              confTextEl.innerHTML = '<span class="text-text-sub-light dark:text-text-sub-dark">confidence ' + confidenceText + '</span>';
            }
          }
        });
      };

      // Fetch logic data from API
      window.fetchLogicData = function() {
        fetch(LOGIC_API_URL, { headers: { 'ngrok-skip-browser-warning': 'true' } })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            // Transform array to object keyed by timeframe
            if (Array.isArray(data)) {
              window.logicData = {};
              data.forEach(function(item) {
                if (item.timeframe) {
                  window.logicData[item.timeframe] = item;
                }
              });
            } else {
              window.logicData = data;
            }

            if (window.logicData[window.currentTimeframe]) {
              window.updateLogicDisplay(window.logicData[window.currentTimeframe]);
            }
            window.updateTimeframeCards(window.logicData);
          })
          .catch(function(err) {
            console.error('Error fetching logic data:', err);
            document.getElementById('logic-thesis').textContent = 'Unable to load market logic data';
          });
      };

      // Timeframe card click handlers
      document.querySelectorAll('.logic-tf-card').forEach(function(card) {
        card.addEventListener('click', function() {
          var tf = this.dataset.tf;
          window.currentTimeframe = tf;

          // Update selected class
          document.querySelectorAll('.logic-tf-card').forEach(function(c) {
            c.classList.remove('selected');
          });
          this.classList.add('selected');

          if (window.logicData && window.logicData[window.currentTimeframe]) {
            window.updateLogicDisplay(window.logicData[window.currentTimeframe]);
          }
          window.updateTimeframeCards(window.logicData || {});
        });
      });

      // Header compact on scroll with hysteresis
      var mainHeader = document.getElementById('mainHeader');
      var isCompact = false;
      var compactThreshold = 10;
      var expandThreshold = 5;

      function handleHeaderScroll() {
        if (!document.body.classList.contains('dashboard-active')) return;

        var scrollY = window.scrollY || window.pageYOffset;

        if (!isCompact && scrollY > compactThreshold) {
          isCompact = true;
          mainHeader.classList.add('compact');
          document.body.classList.add('header-compact');
        } else if (isCompact && scrollY < expandThreshold) {
          isCompact = false;
          mainHeader.classList.remove('compact');
          document.body.classList.remove('header-compact');
        }
      }

      // Use requestAnimationFrame for smoother updates
      var scrollTicking = false;
      window.addEventListener('scroll', function() {
        if (!scrollTicking) {
          requestAnimationFrame(function() {
            handleHeaderScroll();
            scrollTicking = false;
          });
          scrollTicking = true;
        }
      }, { passive: true });

      // Fetch data on page load
      window.addEventListener('DOMContentLoaded', function() {
        window.fetchLogicData();
      });
    })();
  </script>
</body>
</html>
